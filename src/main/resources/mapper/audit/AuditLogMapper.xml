<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zinidata.audit.mapper.AuditLogMapper">

    <!-- ==================== Í∏∞Î≥∏ CRUD ==================== -->
    
    <!-- Í∞êÏÇ¨ Î°úÍ∑∏ ÏÇΩÏûÖ -->
    <insert id="insertAuditLog" parameterType="com.zinidata.audit.vo.AuditLogVO">
        /** üü¢ AuditLogMapper.insertAuditLog - Í∞êÏÇ¨ Î°úÍ∑∏ ÏÇΩÏûÖ
         *  API: Î™®Îì† @AuditLog Ïñ¥ÎÖ∏ÌÖåÏù¥ÏÖò Ï†ÅÏö© API Ìò∏Ï∂ú Ïãú ÏûêÎèô Ïã§Ìñâ
         *  Î™©Ï†Å: ÏÇ¨Ïö©Ïûê ÌñâÎèô, API Ìò∏Ï∂ú, Î≥¥Ïïà Ïù¥Î≤§Ìä∏ Îì± Î™®Îì† Í∞êÏÇ¨ Î°úÍ∑∏ Í∏∞Î°ù
         */
        INSERT INTO TB_AUDIT_LOG (
            MEM_NO,
            PRJ_TYPE,
            CLIENT_IP,
            REQUEST_URI,
            HTTP_METHOD,
            PARAMETERS,
            USER_AGENT,
            ACTION_TYPE,
            TARGET_RESOURCE,
            RESULT_STATUS,
            ERROR_MESSAGE,
            ACCESS_TIME,
            PROCESSING_TIME,
            REFERRER,
            SESSION_ID
        ) VALUES (
            #{memNo},
            #{prjType},
            #{clientIp},
            #{requestUri},
            #{httpMethod},
            #{parameters},
            #{userAgent},
            #{actionType},
            #{targetResource},
            #{resultStatus},
            #{errorMessage},
            #{accessTime},
            #{processingTime},
            #{referrer},
            #{sessionId}
        )
    </insert>

    <!-- ==================== Í∏∞Î≥∏ Ï°∞Ìöå ==================== -->
    
    <!-- ÌäπÏ†ï ÌöåÏõêÏùò Í∞êÏÇ¨ Î°úÍ∑∏ Ï°∞Ìöå -->
    <select id="selectAuditLogsByMemNo" resultType="com.zinidata.audit.vo.AuditLogVO">
        /** üü¢ AuditLogMapper.selectAuditLogsByMemNo - ÌöåÏõêÎ≥Ñ Í∞êÏÇ¨ Î°úÍ∑∏ Ï°∞Ìöå
         *  API: Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÏóêÏÑú ÌäπÏ†ï ÌöåÏõêÏùò ÌôúÎèô Î°úÍ∑∏ Ï°∞Ìöå Ïãú ÏÇ¨Ïö©
         *  Î™©Ï†Å: ÌöåÏõêÎ≥Ñ ÌñâÎèô Ìå®ÌÑ¥ Î∂ÑÏÑù Î∞è Î≥¥Ïïà Î™®ÎãàÌÑ∞ÎßÅ
         */
        SELECT 
            MEM_NO AS memNo,
            PRJ_TYPE AS prjType,
            CLIENT_IP AS clientIp,
            REQUEST_URI AS requestUri,
            HTTP_METHOD AS httpMethod,
            PARAMETERS,
            USER_AGENT AS userAgent,
            ACTION_TYPE AS actionType,
            TARGET_RESOURCE AS targetResource,
            RESULT_STATUS AS resultStatus,
            ERROR_MESSAGE AS errorMessage,
            ACCESS_TIME AS accessTime,
            PROCESSING_TIME AS processingTime,
            REFERRER,
            SESSION_ID AS sessionId
        FROM 
            TB_AUDIT_LOG
        WHERE 
            MEM_NO = #{memNo}
        <if test="startDate != null">
            AND ACCESS_TIME >= #{startDate}
        </if>
        <if test="endDate != null">
            AND ACCESS_TIME &lt;= #{endDate}
        </if>
        ORDER BY 
            ACCESS_TIME DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- ÌäπÏ†ï Ïï°ÏÖò ÌÉÄÏûÖÏùò Í∞êÏÇ¨ Î°úÍ∑∏ Ï°∞Ìöå -->
    <select id="selectAuditLogsByActionType" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            mem_no AS memNo,
            prj_type AS prjType,
            client_ip AS clientIp,
            request_uri AS requestUri,
            http_method AS httpMethod,
            parameters,
            user_agent AS userAgent,
            action_type AS actionType,
            target_resource AS targetResource,
            result_status AS resultStatus,
            error_message AS errorMessage,
            access_time AS accessTime,
            processing_time AS processingTime,
            referrer,
            session_id AS sessionId
        FROM tb_audit_log
        WHERE action_type = #{actionType}
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        ORDER BY access_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- ÌäπÏ†ï Í∏∞Í∞ÑÏùò Í∞êÏÇ¨ Î°úÍ∑∏ Ï°∞Ìöå -->
    <select id="selectAuditLogsByDateRange" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            mem_no AS memNo,
            prj_type AS prjType,
            client_ip AS clientIp,
            request_uri AS requestUri,
            http_method AS httpMethod,
            parameters,
            user_agent AS userAgent,
            action_type AS actionType,
            target_resource AS targetResource,
            result_status AS resultStatus,
            error_message AS errorMessage,
            access_time AS accessTime,
            processing_time AS processingTime,
            referrer,
            session_id AS sessionId
        FROM tb_audit_log
        WHERE 1=1
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        ORDER BY access_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ==================== Î≥¥Ïïà Î™®ÎãàÌÑ∞ÎßÅ ==================== -->
    
    <!-- Ïã§Ìå®Ìïú Î°úÍ∑∏Ïù∏ ÏãúÎèÑ ÌöüÏàò Ï°∞Ìöå -->
    <select id="countFailedLoginAttempts" resultType="int">
        /** üü¢ AuditLogMapper.countFailedLoginAttempts - IPÎ≥Ñ Î°úÍ∑∏Ïù∏ Ïã§Ìå® ÌöüÏàò Ï°∞Ìöå
         *  API: Î≥¥Ïïà ÌïÑÌÑ∞ÏóêÏÑú Î∏åÎ£®Ìä∏Ìè¨Ïä§ Í≥µÍ≤© Í∞êÏßÄ Ïãú ÏÇ¨Ïö©
         *  Î™©Ï†Å: ÌäπÏ†ï IPÏùò ÏµúÍ∑º Î°úÍ∑∏Ïù∏ Ïã§Ìå® ÌöüÏàò Ï≤¥ÌÅ¨Î°ú Í≥ÑÏ†ï Ïû†Í∏à Î∞è Ï∞®Îã® Í≤∞Ï†ï
         */
        SELECT COUNT(*)
        FROM TB_AUDIT_LOG
        WHERE CLIENT_IP = #{clientIp}
          AND ACTION_TYPE = 'Î°úÍ∑∏Ïù∏'
          AND RESULT_STATUS IN ('FAILURE', 'UNAUTHORIZED')
          AND ACCESS_TIME >= NOW() - INTERVAL '#{minutes} minutes'
    </select>
    
    <!-- ÌäπÏ†ï ÌöåÏõêÏùò Ïã§Ìå®Ìïú Î°úÍ∑∏Ïù∏ ÏãúÎèÑ ÌöüÏàò Ï°∞Ìöå -->
    <select id="countFailedLoginAttemptsByMemNo" resultType="int">
        /** üü¢ AuditLogMapper.countFailedLoginAttemptsByMemNo - ÌöåÏõêÎ≥Ñ Î°úÍ∑∏Ïù∏ Ïã§Ìå® ÌöüÏàò Ï°∞Ìöå
         *  API: Î≥¥Ïïà ÌïÑÌÑ∞ÏóêÏÑú ÌäπÏ†ï ÌöåÏõêÏùò Í≥ÑÏ†ï Î≥¥Ïïà ÏÉÅÌÉú Ï≤¥ÌÅ¨ Ïãú ÏÇ¨Ïö©
         *  Î™©Ï†Å: ÌöåÏõêÎ≥Ñ ÏµúÍ∑º Î°úÍ∑∏Ïù∏ Ïã§Ìå® ÌöüÏàòÎ°ú Í≥ÑÏ†ï Ïû†Í∏à Ïó¨Î∂Ä Í≤∞Ï†ï
         */
        SELECT COUNT(*)
        FROM TB_AUDIT_LOG
        WHERE MEM_NO = #{memNo}
          AND ACTION_TYPE = 'Î°úÍ∑∏Ïù∏'
          AND RESULT_STATUS IN ('FAILURE', 'UNAUTHORIZED')
          AND ACCESS_TIME >= NOW() - INTERVAL '#{minutes} minutes'
    </select>
    
    <!-- Î¨¥Îã® Ïï°ÏÑ∏Ïä§ ÏãúÎèÑ Ï°∞Ìöå -->
    <select id="selectUnauthorizedAttempts" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            mem_no AS memNo,
            prj_type AS prjType,
            client_ip AS clientIp,
            request_uri AS requestUri,
            http_method AS httpMethod,
            parameters,
            user_agent AS userAgent,
            action_type AS actionType,
            target_resource AS targetResource,
            result_status AS resultStatus,
            error_message AS errorMessage,
            access_time AS accessTime,
            processing_time AS processingTime,
            referrer,
            session_id AS sessionId
        FROM tb_audit_log
        WHERE result_status IN ('UNAUTHORIZED', 'FORBIDDEN')
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        ORDER BY access_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ==================== ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ ==================== -->
    
    <!-- Ï≤òÎ¶¨ ÏãúÍ∞ÑÏù¥ Ïò§Îûò Í±∏Î¶∞ ÏöîÏ≤≠ Ï°∞Ìöå -->
    <select id="selectSlowRequests" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            mem_no AS memNo,
            prj_type AS prjType,
            client_ip AS clientIp,
            request_uri AS requestUri,
            http_method AS httpMethod,
            parameters,
            user_agent AS userAgent,
            action_type AS actionType,
            target_resource AS targetResource,
            result_status AS resultStatus,
            error_message AS errorMessage,
            access_time AS accessTime,
            processing_time AS processingTime,
            referrer,
            session_id AS sessionId
        FROM tb_audit_log
        WHERE processing_time >= #{thresholdMs}
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        ORDER BY processing_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- Ïï°ÏÖò ÌÉÄÏûÖÎ≥Ñ ÌèâÍ∑† Ï≤òÎ¶¨ ÏãúÍ∞Ñ Ï°∞Ìöå -->
    <select id="selectAverageProcessingTimeByActionType" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            action_type AS actionType,
            COUNT(*) AS processingTime,
            AVG(processing_time) AS averageProcessingTime,
            MIN(processing_time) AS minProcessingTime,
            MAX(processing_time) AS maxProcessingTime
        FROM tb_audit_log
        WHERE processing_time IS NOT NULL
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        GROUP BY action_type
        ORDER BY AVG(processing_time) DESC
    </select>

    <!-- ==================== Ïû•Ïï† Î™®ÎãàÌÑ∞ÎßÅ ==================== -->
    
    <!-- ÏóêÎü¨ Î°úÍ∑∏ Ï°∞Ìöå -->
    <select id="selectErrorLogs" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            mem_no AS memNo,
            prj_type AS prjType,
            client_ip AS clientIp,
            request_uri AS requestUri,
            http_method AS httpMethod,
            parameters,
            user_agent AS userAgent,
            action_type AS actionType,
            target_resource AS targetResource,
            result_status AS resultStatus,
            error_message AS errorMessage,
            access_time AS accessTime,
            processing_time AS processingTime,
            referrer,
            session_id AS sessionId
        FROM tb_audit_log
        WHERE result_status = 'ERROR'
           OR error_message IS NOT NULL
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        ORDER BY access_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- ÌäπÏ†ï URIÏùò ÏóêÎü¨ Î∞úÏÉù ÌöüÏàò Ï°∞Ìöå -->
    <select id="countErrorsByRequestUri" resultType="int">
        SELECT COUNT(*)
        FROM tb_audit_log
        WHERE request_uri = #{requestUri}
          AND (result_status = 'ERROR' OR error_message IS NOT NULL)
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
    </select>

    <!-- ==================== ÌÜµÍ≥Ñ Î∞è Î∂ÑÏÑù ==================== -->
    
    <!-- ÏùºÎ≥Ñ Ïï°ÏÖò ÌÉÄÏûÖÎ≥Ñ ÌÜµÍ≥Ñ Ï°∞Ìöå -->
    <select id="selectDailyStatsByActionType" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            access_time::date AS accessDate,
            action_type AS actionType,
            COUNT(*) AS totalCount,
            SUM(CASE WHEN result_status = 'SUCCESS' THEN 1 ELSE 0 END) AS successCount,
            SUM(CASE WHEN result_status != 'SUCCESS' THEN 1 ELSE 0 END) AS failureCount
        FROM tb_audit_log
        WHERE 1=1
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        GROUP BY access_time::date, action_type
        ORDER BY access_time::date DESC, action_type
    </select>
    
    <!-- ÏãúÍ∞ÑÎåÄÎ≥Ñ Ï†ëÏÜç ÌÜµÍ≥Ñ Ï°∞Ìöå -->
    <select id="selectHourlyAccessStats" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            EXTRACT(HOUR FROM access_time) AS accessHour,
            COUNT(*) AS totalCount,
            COUNT(DISTINCT client_ip) AS uniqueIpCount,
            COUNT(DISTINCT mem_no) AS uniqueUserCount
        FROM tb_audit_log
        WHERE 1=1
        <if test="startDate != null">
            AND access_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND access_time &lt;= #{endDate}
        </if>
        GROUP BY EXTRACT(HOUR FROM access_time)
        ORDER BY EXTRACT(HOUR FROM access_time)
    </select>

    <!-- ==================== Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ==================== -->
    
    <!-- Ïò§ÎûòÎêú Î°úÍ∑∏ ÏÇ≠Ï†ú -->
    <delete id="deleteOldLogs">
        DELETE FROM tb_audit_log
        WHERE access_time &lt; NOW() - INTERVAL '#{retentionMonths} months'
    </delete>
    
    <!-- Î°úÍ∑∏ ÌÖåÏù¥Î∏î ÌÜµÍ≥Ñ Ï°∞Ìöå -->
    <select id="selectTableStatistics" resultType="com.zinidata.audit.vo.AuditLogVO">
        SELECT 
            COUNT(*) AS totalCount,
            COUNT(DISTINCT mem_no) AS uniqueUserCount,
            COUNT(DISTINCT client_ip) AS uniqueIpCount,
            MIN(access_time) AS oldestRecord,
            MAX(access_time) AS newestRecord,
            SUM(CASE WHEN result_status = 'SUCCESS' THEN 1 ELSE 0 END) AS successCount,
            SUM(CASE WHEN result_status != 'SUCCESS' THEN 1 ELSE 0 END) AS failureCount
        FROM tb_audit_log
    </select>

</mapper> 
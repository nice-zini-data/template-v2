<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zinidata.domain.admin.mapper.NewsMapper">

    <!-- 
        ========================================
        Îâ¥Ïä§ Í∏∞ÏÇ¨ Í¥ÄÎ¶¨ Îß§Ìçº (MyBatis)
        ========================================
        
        ÌÖåÏù¥Î∏î: tb_news
        
        Ï£ºÏöî Í∏∞Îä•:
        - Îâ¥Ïä§ Îì±Î°ù/ÏàòÏ†ï/ÏÇ≠Ï†ú
        - Îâ¥Ïä§ Î™©Î°ù Ï°∞Ìöå (ÌéòÏù¥Ïßï, Í≤ÄÏÉâ, ÌïÑÌÑ∞ÎßÅ)
        - Îâ¥Ïä§ ÏÉÅÏÑ∏ Ï°∞Ìöå
        - Ï°∞ÌöåÏàò/Ï¢ãÏïÑÏöî Ïàò Í¥ÄÎ¶¨
        - ÏÉÅÎã® Í≥†Ï†ï Í∏∞Îä•
        
        @author ZiniData Í∞úÎ∞úÌåÄ
        @since 1.0
    -->

    <!-- ========================================
         Îì±Î°ù/ÏàòÏ†ï/ÏÇ≠Ï†ú
         ======================================== -->

    <!-- üü¢ Îâ¥Ïä§ Í∏∞ÏÇ¨ Îì±Î°ù -->
    <insert id="insertNews" parameterType="com.zinidata.domain.admin.vo.NewsVO" useGeneratedKeys="true" keyProperty="newsId">
        INSERT INTO tb_news (
            title,
            summary,
            status,
            content_html,
            content_markdown,
            publish_date,
            published_at,
            view_count,
            like_count,
            author_id,
            author_name,
            is_pinned,
            is_active,
            created_at,
            created_by
        ) VALUES (
            #{title},
            #{summary},
            #{status},
            #{contentHtml},
            #{contentMarkdown},
            #{publishDate},
            <choose>
                <when test="status == 'published'">
                    CURRENT_TIMESTAMP
                </when>
                <otherwise>
                    NULL
                </otherwise>
            </choose>,
            0,
            0,
            #{authorId},
            #{authorName},
            COALESCE(#{isPinned}, false),
            true,
            CURRENT_TIMESTAMP,
            #{createdBy}
        )
    </insert>

    <!-- üü¢ Îâ¥Ïä§ Í∏∞ÏÇ¨ ÏàòÏ†ï -->
    <update id="updateNews" parameterType="com.zinidata.domain.admin.vo.NewsVO">
        UPDATE tb_news
        SET
            title = #{title},
            summary = #{summary},
            status = #{status},
            content_html = #{contentHtml},
            content_markdown = #{contentMarkdown},
            publish_date = #{publishDate},
            <if test="status == 'published' and publishedAt == null">
            published_at = CURRENT_TIMESTAMP,
            </if>
            author_id = #{authorId},
            author_name = #{authorName},
            is_pinned = COALESCE(#{isPinned}, false),
            updated_at = CURRENT_TIMESTAMP,
            updated_by = #{updatedBy}
        WHERE news_id = #{newsId}
          AND is_active = true
    </update>

    <!-- üü¢ Îâ¥Ïä§ Î∞úÌñâ ÏÉÅÌÉú Î≥ÄÍ≤Ω -->
    <update id="updateNewsStatus">
        UPDATE tb_news
        SET
            status = #{status},
            <if test="status == 'published'">
            published_at = CURRENT_TIMESTAMP,
            </if>
            updated_at = CURRENT_TIMESTAMP,
            updated_by = #{updatedBy}
        WHERE news_id = #{newsId}
          AND is_active = true
    </update>

    <!-- üü¢ Îâ¥Ïä§ Í∏∞ÏÇ¨ ÏÇ≠Ï†ú (ÎÖºÎ¶¨Ï†Å ÏÇ≠Ï†ú) -->
    <update id="deleteNews">
        UPDATE tb_news
        SET
            is_active = false,
            updated_at = CURRENT_TIMESTAMP,
            updated_by = #{updatedBy}
        WHERE news_id = #{newsId}
    </update>

    <!-- ========================================
         Ï°∞Ìöå
         ======================================== -->

    <!-- üü¢ Îâ¥Ïä§ Í∏∞ÏÇ¨ Î™©Î°ù Ï°∞Ìöå (ÌéòÏù¥Ïßï) -->
    <select id="selectNewsList" resultType="com.zinidata.domain.admin.vo.NewsVO">
        SELECT 
            a.*,
            (a.total_row_count - a.rn + 1) as rowNum
        FROM (
            SELECT 
                news_id as newsId,
                title,
                summary,
                status,
                content_html as contentHtml,
                content_markdown as contentMarkdown,
                publish_date as publishDate,
                published_at as publishedAt,
                view_count as viewCount,
                like_count as likeCount,
                author_id as authorId,
                author_name as authorName,
                is_pinned as isPinned,
                is_active as isActive,
                created_at as createdAt,
                created_by as createdBy,
                updated_at as updatedAt,
                updated_by as updatedBy,
                -- ÌéòÏù¥ÏßïÏö© ÏúàÎèÑÏö∞ Ìï®Ïàò
                ROW_NUMBER() OVER(
                    ORDER BY 
                        is_pinned DESC,      -- ÏÉÅÎã® Í≥†Ï†ï Ïö∞ÏÑ†
                        publish_date DESC,   -- Î∞úÌñâÏùº ÏµúÏã†Ïàú
                        news_id DESC         -- ÎèôÏùº Î∞úÌñâÏùºÏùÄ ID ÏµúÏã†Ïàú
                ) as rn,
                COUNT(*) OVER() as total_row_count
            FROM tb_news
            WHERE is_active = true
            
            <!-- ÏÉÅÌÉú ÌïÑÌÑ∞ -->
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            
            <!-- Í≤ÄÏÉâÏñ¥ (Ï†úÎ™© + ÏöîÏïΩ) -->
            <if test="searchText != null and searchText != ''">
                AND (
                    title LIKE CONCAT('%', #{searchText}, '%')
                    OR summary LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        ) a
        
        <!-- ÌéòÏù¥Ïßï -->
        <if test="pageCnt > 0">
            LIMIT #{pageCnt} OFFSET #{pageNo}
        </if>
    </select>

    <!-- üü¢ Îâ¥Ïä§ Í∏∞ÏÇ¨ Ï†ÑÏ≤¥ Í∞úÏàò Ï°∞Ìöå -->
    <select id="selectNewsCount" resultType="int">
        SELECT COUNT(*)
        FROM tb_news
        WHERE is_active = true
        
        <!-- ÏÉÅÌÉú ÌïÑÌÑ∞ -->
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        
        <!-- Í≤ÄÏÉâÏñ¥ (Ï†úÎ™© + ÏöîÏïΩ) -->
        <if test="searchText != null and searchText != ''">
            AND (
                title LIKE CONCAT('%', #{searchText}, '%')
                OR summary LIKE CONCAT('%', #{searchText}, '%')
            )
        </if>
    </select>

    <!-- üü¢ Îâ¥Ïä§ Í∏∞ÏÇ¨ ÏÉÅÏÑ∏ Ï°∞Ìöå -->
    <select id="selectNewsDetail" resultType="com.zinidata.domain.admin.vo.NewsVO">
        SELECT 
            news_id as newsId,
            title,
            summary,
            status,
            content_html as contentHtml,
            content_markdown as contentMarkdown,
            publish_date as publishDate,
            published_at as publishedAt,
            view_count as viewCount,
            like_count as likeCount,
            author_id as authorId,
            author_name as authorName,
            is_pinned as isPinned,
            is_active as isActive,
            created_at as createdAt,
            created_by as createdBy,
            updated_at as updatedAt,
            updated_by as updatedBy
        FROM tb_news
        WHERE news_id = #{newsId}
          AND is_active = true
    </select>

    <!-- ========================================
         ÌÜµÍ≥Ñ/Î∂ÄÍ∞Ä Í∏∞Îä•
         ======================================== -->

    <!-- üü¢ Îâ¥Ïä§ Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä -->
    <update id="updateViewCount">
        UPDATE tb_news
        SET view_count = view_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE news_id = #{newsId}
          AND is_active = true
    </update>

    <!-- üü¢ Îâ¥Ïä§ Ï¢ãÏïÑÏöî Ïàò Ï¶ùÍ∞Ä -->
    <update id="updateLikeCount">
        UPDATE tb_news
        SET like_count = like_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE news_id = #{newsId}
          AND is_active = true
    </update>

    <!-- üü¢ ÏÉÅÎã® Í≥†Ï†ï ÌÜ†Í∏Ä -->
    <update id="updatePinned">
        UPDATE tb_news
        SET is_pinned = #{isPinned},
            updated_at = CURRENT_TIMESTAMP,
            updated_by = #{updatedBy}
        WHERE news_id = #{newsId}
          AND is_active = true
    </update>

</mapper>


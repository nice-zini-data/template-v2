<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zinidata.domain.common.upjong.mapper.UpjongMapper">

    <!-- ÎåÄÎ∂ÑÎ•ò ÏóÖÏ¢Ö Î™©Î°ù Ï°∞Ìöå -->
    <select id="selectUpjong1List" resultType="map">
        SELECT 
            upjong1_cd AS "upjong1Cd",
            upjong1_nm AS "upjong1Nm"
        FROM tb_upjong1
        WHERE 1 = 1
        ORDER BY upjong1_cd
    </select>

    <!-- Ï§ëÎ∂ÑÎ•ò ÏóÖÏ¢Ö Î™©Î°ù Ï°∞Ìöå -->
    <select id="selectUpjong2List" resultType="map">
        SELECT 
            upjong1_cd AS "upjong1Cd",
            upjong2_cd AS "upjong2Cd",
            upjong2_nm AS "upjong2Nm"
        FROM tb_upjong2
        WHERE 1 = 1
        <if test="upjong1Cd != null and upjong1Cd != ''">
            AND upjong1_cd = #{upjong1Cd}
        </if>
        ORDER BY upjong1_cd, upjong2_cd
    </select>

    <!-- ÏÜåÎ∂ÑÎ•ò ÏóÖÏ¢Ö Î™©Î°ù Ï°∞Ìöå -->
    <select id="selectUpjong3List" resultType="map">
        SELECT 
            upjong2_cd AS "upjong2Cd",
            upjong3_cd AS "upjong3Cd",
            upjong3_nm AS "upjong3Nm"
        FROM tb_upjong3
        WHERE svc_yn = 'Y'
        <if test="upjong2Cd != null and upjong2Cd != ''">
            AND upjong2_cd = #{upjong2Cd}
        </if>
        ORDER BY upjong2_cd, upjong3_cd
    </select>

    <!-- Ï†ÑÏ≤¥ ÏóÖÏ¢Ö Í≥ÑÏ∏µÍµ¨Ï°∞ Ï°∞Ìöå -->
    <select id="selectUpjongHierarchy" resultType="map">
        SELECT 
            a.upjong1_cd AS "upjong1Cd", 
            a.upjong1_nm AS "upjong1Nm", 
            b.upjong2_cd AS "upjong2Cd", 
            b.upjong2_nm AS "upjong2Nm", 
            c.upjong3_cd AS "upjong3Cd", 
            c.upjong3_nm AS "upjong3Nm"
        FROM tb_upjong1 a 
        JOIN tb_upjong2 b ON a.upjong1_cd = b.upjong1_cd 
        JOIN tb_upjong3 c ON b.upjong2_cd = c.upjong2_cd 
        WHERE c.svc_yn = 'Y'
        ORDER BY a.upjong1_cd, b.upjong2_cd, c.upjong3_cd
    </select>

    <!-- ÏóÖÏ¢Ö Í≥ÑÏ∏µÍµ¨Ï°∞ Ï°∞Ìöå (ÌïÑÌÑ∞ÎßÅ Í∞ÄÎä•) -->
    <select id="selectUpjongHierarchyByCode" resultType="map">
        SELECT 
            a.upjong1_cd AS "upjong1Cd", 
            a.upjong1_nm AS "upjong1Nm", 
            b.upjong2_cd AS "upjong2Cd", 
            b.upjong2_nm AS "upjong2Nm", 
            c.upjong3_cd AS "upjong3Cd", 
            c.upjong3_nm AS "upjong3Nm"
        FROM tb_upjong1 a 
        JOIN tb_upjong2 b ON a.upjong1_cd = b.upjong1_cd 
        JOIN tb_upjong3 c ON b.upjong2_cd = c.upjong2_cd 
        WHERE c.svc_yn = 'Y'
        <if test="upjongCode != null and upjongCode != ''">
            <!-- ÏóÖÏ¢Ö ÏΩîÎìú Í∏∏Ïù¥Ïóê Îî∞Î•∏ ÎèôÏ†Å ÌïÑÌÑ∞ÎßÅ -->
            <choose>
                <when test="upjongCode.length() == 1">
                    <!-- ÎåÄÎ∂ÑÎ•ò ÌïÑÌÑ∞ÎßÅ (Ïòà: 'Q') -->
                    AND a.upjong1_cd = #{upjongCode}
                </when>
                <when test="upjongCode.length() == 3">
                    <!-- Ï§ëÎ∂ÑÎ•ò ÌïÑÌÑ∞ÎßÅ (Ïòà: 'Q13') -->
                    AND b.upjong2_cd = #{upjongCode}
                </when>
                <when test="upjongCode.length() == 6">
                    <!-- ÏÜåÎ∂ÑÎ•ò ÌïÑÌÑ∞ÎßÅ (Ïòà: 'Q13007') -->
                    AND c.upjong3_cd = #{upjongCode}
                </when>
            </choose>
        </if>
        ORDER BY a.upjong1_cd, b.upjong2_cd, c.upjong3_cd
    </select>

    <!-- ÌäπÏ†ï ÌñâÏ†ïÎèôÏùò ÏóÖÏ¢ÖÎ≥Ñ Í∞ÄÎßπÏ†ê Ïàò Ï°∞Ìöå -->
    <select id="selectUpjongStoreCountByAdmi" resultType="map">
        SELECT 
            s.upjong3_cd AS "upjong3Cd",
            u.upjong3_nm AS "upjong3Nm",
            u.upjong2_cd AS "upjong2Cd",
            u2.upjong2_nm AS "upjong2Nm",
            u2.upjong1_cd AS "upjong1Cd",
            u1.upjong1_nm AS "upjong1Nm",
            COUNT(*) AS "storeCount",
            CASE 
                WHEN COUNT(*) >= 3 THEN 'Y'
                ELSE 'N'
            END AS "analyzable"
        FROM tb_store s
        INNER JOIN tb_upjong3 u ON s.upjong3_cd = u.upjong3_cd
        INNER JOIN tb_upjong2 u2 ON u.upjong2_cd = u2.upjong2_cd
        INNER JOIN tb_upjong1 u1 ON u2.upjong1_cd = u1.upjong1_cd
        WHERE s.admi_cd = #{admiCd}
          AND s.use_yn = 'Y'
          AND u.svc_yn = 'Y'
          AND u2.svc_yn = 'Y'
          AND u1.svc_yn = 'Y'
        GROUP BY s.upjong3_cd, u.upjong3_nm, u.upjong2_cd, u2.upjong2_nm, u2.upjong1_cd, u1.upjong1_nm
        ORDER BY COUNT(*) DESC, s.upjong3_cd
    </select>

    <!-- ÏóÖÏ¢ÖÎ™ÖÏúºÎ°ú ÏóÖÏ¢Ö Í≤ÄÏÉâ -->
    <select id="selectUpjongByName" resultType="map">
        /** üü¢ UpjongMapper.selectUpjongByName - ÏóÖÏ¢ÖÎ™ÖÏúºÎ°ú ÏóÖÏ¢Ö Í≤ÄÏÉâ
         *  API: GET /api/common/upjong/search
         *  Î™©Ï†Å: ÏóÖÏ¢ÖÎ™Ö ÌÇ§ÏõåÎìúÎ°ú ÏùºÏπòÌïòÎäî Ï§ëÎ∂ÑÎ•ò ÏΩîÎìú Î™©Î°ù Ï°∞Ìöå
         */
        SELECT DISTINCT 
            UPJONG2_CD AS "upjong2Cd"
        FROM 
            TB_UPJONG3
        WHERE 
            UPJONG3_NM LIKE CONCAT('%', #{upjong3Nm}, '%')
            AND SVC_YN = 'Y'
        ORDER BY 
            UPJONG2_CD
    </select>

    <!-- ÌäπÏ†ï Ï§ëÎ∂ÑÎ•ò ÏΩîÎìúÎì§Ïùò Ï†ÑÏ≤¥ Í≥ÑÏ∏µÍµ¨Ï°∞ Ï°∞Ìöå -->
    <select id="selectUpjongHierarchyByCodes" resultType="map">
        /** üî¥ UpjongMapper.selectUpjongHierarchyByCodes - ÌäπÏ†ï Ï§ëÎ∂ÑÎ•ò ÏΩîÎìúÎì§Ïùò Ï†ÑÏ≤¥ Í≥ÑÏ∏µÍµ¨Ï°∞ Ï°∞Ìöå */
        SELECT 
            a.upjong1_cd AS "upjong1Cd", 
            a.upjong1_nm AS "upjong1Nm", 
            b.upjong2_cd AS "upjong2Cd", 
            b.upjong2_nm AS "upjong2Nm", 
            c.upjong3_cd AS "upjong3Cd", 
            c.upjong3_nm AS "upjong3Nm"
        FROM tb_upjong1 a 
        JOIN tb_upjong2 b ON a.upjong1_cd = b.upjong1_cd 
        JOIN tb_upjong3 c ON b.upjong2_cd = c.upjong2_cd 
        WHERE c.svc_yn = 'Y'
          AND b.upjong2_cd IN
          <foreach collection="upjong2Cds" item="upjong2Cd" open="(" close=")" separator=",">
              #{upjong2Cd}
          </foreach>
        ORDER BY a.upjong1_cd, b.upjong2_cd, c.upjong3_cd
    </select>

    <!-- ÌäπÏ†ï Ï§ëÎ∂ÑÎ•ò ÏΩîÎìúÎì§Ïùò Ï†ÑÏ≤¥ Í≥ÑÏ∏µÍµ¨Ï°∞ + ÌôïÏû• Ï†êÌè¨Ïàò/Î∂ÑÏÑùÍ∞ÄÎä• Ïó¨Î∂Ä Ìè¨Ìï® -->
    <select id="selectUpjongHierarchyByCodesWithExpandedStore" resultType="map">
        /** üü¢ UpjongMapper.selectUpjongHierarchyByCodesWithExpandedStore - ÏóÖÏ¢Ö Í≥ÑÏ∏µÍµ¨Ï°∞ + Ï†êÌè¨Ïàò Ï°∞Ìöå
         *  API: GET /api/common/upjong/search
         *  Î™©Ï†Å: Ï§ëÎ∂ÑÎ•ò ÏΩîÎìúÎ°ú Ï†ÑÏ≤¥ ÏóÖÏ¢Ö Í≥ÑÏ∏µÍµ¨Ï°∞ + Í∏∞Î≥∏/ÌôïÏû• Ï†êÌè¨Ïàò Î∞è Î∂ÑÏÑùÏÉÅÌÉú Ï°∞Ìöå
         */
        SELECT 
            A.UPJONG1_CD AS "upjong1Cd", 
            A.UPJONG1_NM AS "upjong1Nm", 
            B.UPJONG2_CD AS "upjong2Cd", 
            B.UPJONG2_NM AS "upjong2Nm", 
            C.UPJONG3_CD AS "upjong3Cd", 
            C.UPJONG3_NM AS "upjong3Nm",
            /* Í∏∞Î≥∏ Ï†êÌè¨Ïàò (ÏÑ†ÌÉù ÌñâÏ†ïÎèôÎßå) */
            COALESCE((
                SELECT SUM(H0.STORE_CNT)
                FROM TBSS_SUM_ADMI_HIS_V3 H0
                WHERE H0.ADMI_CD = #{admiCd}
                  AND H0.UPJONG3_CD = C.UPJONG3_CD
                  AND H0.BUPIN_GB = '1'
                  AND H0.YYYYMM = (
                      SELECT BL0.BATCH_YM FROM TB_BATCH_LOG BL0 ORDER BY BL0.BATCH_YM DESC LIMIT 1
                  )
            ), 0) AS "basicStoreCnt",
            /* ÌôïÏû• Ï†êÌè¨Ïàò (Ïù∏Ï†ëÎèô Ìè¨Ìï®) */
            COALESCE((
                SELECT SUM(H.STORE_CNT)
                FROM TB_ADMI_TOUCH T
                INNER JOIN TBSS_SUM_ADMI_HIS_V3 H ON T.STD_ADMI_CD = H.ADMI_CD
                WHERE T.STD_ADMI_CD = #{admiCd}
                  AND H.UPJONG3_CD = C.UPJONG3_CD
                  AND H.BUPIN_GB = '1'
                  AND H.YYYYMM = (
                      SELECT BL.BATCH_YM FROM TB_BATCH_LOG BL ORDER BY BL.BATCH_YM DESC LIMIT 1
                  )
            ), 0) AS "expandedStoreCnt",
            CASE 
                WHEN COALESCE((
                    SELECT SUM(HB.STORE_CNT)
                    FROM TBSS_SUM_ADMI_HIS_V3 HB
                    WHERE HB.ADMI_CD = #{admiCd}
                      AND HB.UPJONG3_CD = C.UPJONG3_CD
                      AND HB.BUPIN_GB = '1'
                      AND HB.YYYYMM = (
                          SELECT BLB.BATCH_YM FROM TB_BATCH_LOG BLB ORDER BY BLB.BATCH_YM DESC LIMIT 1
                      )
                ), 0) >= 4 THEN 'BASIC'
                WHEN COALESCE((
                    SELECT SUM(H2.STORE_CNT)
                    FROM TB_ADMI_TOUCH T2
                    INNER JOIN TBSS_SUM_ADMI_HIS_V3 H2 ON T2.STD_ADMI_CD = H2.ADMI_CD
                    WHERE T2.STD_ADMI_CD = #{admiCd}
                      AND H2.UPJONG3_CD = C.UPJONG3_CD
                      AND H2.BUPIN_GB = '1'
                      AND H2.YYYYMM = (
                          SELECT BL2.BATCH_YM FROM TB_BATCH_LOG BL2 ORDER BY BL2.BATCH_YM DESC LIMIT 1
                      )
                ), 0) >= 4 THEN 'EXPANDED'
                ELSE 'NOT'
            END AS "analysisStatus"
        FROM 
            TB_UPJONG1 A 
        INNER JOIN 
            TB_UPJONG2 B ON A.UPJONG1_CD = B.UPJONG1_CD 
        INNER JOIN 
            TB_UPJONG3 C ON B.UPJONG2_CD = C.UPJONG2_CD 
        WHERE 
            C.SVC_YN = 'Y'
            AND B.UPJONG2_CD IN
            <foreach collection="upjong2Cds" item="upjong2Cd" open="(" close=")" separator=",">
                #{upjong2Cd}
            </foreach>
        ORDER BY 
            A.UPJONG1_CD, B.UPJONG2_CD, C.UPJONG3_CD
    </select>

</mapper> 
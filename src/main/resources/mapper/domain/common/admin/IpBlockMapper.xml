<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zinidata.domain.common.admin.mapper.IpBlockMapper">

    <!-- í™œì„± ì°¨ë‹¨ ì¡°íšŒ -->
    <select id="findActiveBlock" parameterType="map" resultType="com.zinidata.domain.common.admin.vo.IpBlockVO">
        /** ğŸ”´ IpBlockMapper.findActiveBlock - í™œì„± ì°¨ë‹¨ ì¡°íšŒ */
        SELECT
            id,
            ip_address AS ipAddress,
            block_reason AS blockReason,
            is_permanent AS isPermanent,
            blocked_at AS blockedAt,
            unblocked_at AS unblockedAt,
            expires_at AS expiresAt,
            project_code AS appCode,
            blocked_by AS blockedBy,
            unblocked_by AS unblockedBy,
            created_at AS createdAt,
            updated_at AS updatedAt,
            status
        FROM
            ip_block
        WHERE
            ip_address = #{ipAddress}
            AND project_code = #{appCode}
            AND status = 'ACTIVE'
            AND (is_permanent = true OR expires_at IS NULL OR expires_at &gt; NOW())
        ;
    </select>

    <!-- í™œì„± ì°¨ë‹¨ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ -->
    <select id="existsActiveBlock" parameterType="map" resultType="int">
        /** ğŸ”´ IpBlockMapper.existsActiveBlock - í™œì„± ì°¨ë‹¨ ì¡´ì¬ í™•ì¸ */
        SELECT
            COUNT(*)
        FROM
            ip_block
        WHERE
            ip_address = #{ipAddress}
            AND project_code = #{appCode}
            AND status = 'ACTIVE'
            AND (is_permanent = true OR expires_at IS NULL OR expires_at &gt; NOW())
        ;
    </select>

    <!-- í”„ë¡œì íŠ¸ë³„ ëª¨ë“  í™œì„± ì°¨ë‹¨ ëª©ë¡ ì¡°íšŒ -->
    <select id="findAllActiveBlocks" parameterType="string" resultType="com.zinidata.domain.common.admin.vo.IpBlockVO">
        /** ğŸ”´ IpBlockMapper.findAllActiveBlocks - í”„ë¡œì íŠ¸ë³„ í™œì„± ì°¨ë‹¨ ëª©ë¡ */
        SELECT
            id,
            ip_address AS ipAddress,
            block_reason AS blockReason,
            is_permanent AS isPermanent,
            blocked_at AS blockedAt,
            unblocked_at AS unblockedAt,
            expires_at AS expiresAt,
            project_code AS appCode,
            blocked_by AS blockedBy,
            unblocked_by AS unblockedBy,
            created_at AS createdAt,
            updated_at AS updatedAt,
            status
        FROM
            ip_block
        WHERE
            project_code = #{appCode}
            AND status = 'ACTIVE'
        ORDER BY
            created_at DESC
        ;
    </select>

    <!-- í”„ë¡œì íŠ¸ë³„ ëª¨ë“  ì°¨ë‹¨ ëª©ë¡ ì¡°íšŒ -->
    <select id="findAllByProjectCode" parameterType="string" resultType="com.zinidata.domain.common.admin.vo.IpBlockVO">
        /** ğŸ”´ IpBlockMapper.findAllByProjectCode - í”„ë¡œì íŠ¸ë³„ ëª¨ë“  ì°¨ë‹¨ ëª©ë¡ */
        SELECT
            id,
            ip_address AS ipAddress,
            block_reason AS blockReason,
            is_permanent AS isPermanent,
            blocked_at AS blockedAt,
            unblocked_at AS unblockedAt,
            expires_at AS expiresAt,
            project_code AS appCode,
            blocked_by AS blockedBy,
            unblocked_by AS unblockedBy,
            created_at AS createdAt,
            updated_at AS updatedAt,
            status
        FROM
            ip_block
        WHERE
            project_code = #{appCode}
        ORDER BY
            created_at DESC
        ;
    </select>

    <!-- ë§Œë£Œëœ ì°¨ë‹¨ ëª©ë¡ ì¡°íšŒ -->
    <select id="findExpiredBlocks" parameterType="java.sql.Timestamp" resultType="com.zinidata.domain.common.admin.vo.IpBlockVO">
        /** ğŸ”´ IpBlockMapper.findExpiredBlocks - ë§Œë£Œëœ ì°¨ë‹¨ ëª©ë¡ */
        SELECT
            id,
            ip_address AS ipAddress,
            block_reason AS blockReason,
            is_permanent AS isPermanent,
            blocked_at AS blockedAt,
            unblocked_at AS unblockedAt,
            expires_at AS expiresAt,
            project_code AS appCode,
            blocked_by AS blockedBy,
            unblocked_by AS unblockedBy,
            created_at AS createdAt,
            updated_at AS updatedAt,
            status
        FROM
            ip_block
        WHERE
            status = 'ACTIVE'
            AND is_permanent = false
            AND expires_at IS NOT NULL
            AND expires_at &lt;= #{currentTime}
        ;
    </select>

    <!-- IP ì°¨ë‹¨ ë“±ë¡ -->
    <insert id="insertIpBlock" parameterType="com.zinidata.domain.common.admin.vo.IpBlockVO" useGeneratedKeys="true" keyProperty="id">
        /** ğŸ”´ IpBlockMapper.insertIpBlock - IP ì°¨ë‹¨ ë“±ë¡ */
        INSERT INTO ip_block (
            ip_address,
            block_reason,
            is_permanent,
            blocked_at,
            expires_at,
            project_code,
            blocked_by,
            created_at,
            updated_at,
            status
        ) VALUES (
            #{ipAddress},
            #{blockReason},
            #{isPermanent},
            COALESCE(#{blockedAt}, NOW()),
            #{expiresAt},
            #{appCode},
            #{blockedBy},
            NOW(),
            NOW(),
            'ACTIVE'
        )
        ;
    </insert>

    <!-- IP ì°¨ë‹¨ í•´ì œ -->
    <update id="unblockIp" parameterType="map">
        /** ğŸ”´ IpBlockMapper.unblockIp - IP ì°¨ë‹¨ í•´ì œ */
        UPDATE ip_block
        SET
            status = 'UNBLOCKED',
            unblocked_at = #{currentTime},
            unblocked_by = #{unblockedBy},
            updated_at = #{currentTime}
        WHERE
            ip_address = #{ipAddress}
            AND project_code = #{appCode}
            AND status = 'ACTIVE'
        ;
    </update>

    <!-- IP ëª©ë¡ ì¼ê´„ ì°¨ë‹¨ í•´ì œ -->
    <update id="unblockIpsBulk" parameterType="map">
        /** ğŸ”´ IpBlockMapper.unblockIpsBulk - IP ëª©ë¡ ì¼ê´„ í•´ì œ */
        UPDATE ip_block
        SET
            status = 'UNBLOCKED',
            unblocked_at = #{currentTime},
            unblocked_by = #{unblockedBy},
            updated_at = #{currentTime}
        WHERE
            ip_address IN
            <foreach collection="ipAddresses" item="ip" open="(" separator="," close=")">
                #{ip}
            </foreach>
            AND project_code = #{appCode}
            AND status = 'ACTIVE'
        ;
    </update>

    <!-- ë§Œë£Œëœ ì°¨ë‹¨ ìƒíƒœ ì—…ë°ì´íŠ¸ -->
    <update id="updateExpiredBlocks" parameterType="java.sql.Timestamp">
        /** ğŸ”´ IpBlockMapper.updateExpiredBlocks - ë§Œë£Œëœ ì°¨ë‹¨ ìƒíƒœ ì—…ë°ì´íŠ¸ */
        UPDATE ip_block
        SET
            status = 'EXPIRED',
            updated_at = #{currentTime}
        WHERE
            status = 'ACTIVE'
            AND is_permanent = false
            AND expires_at IS NOT NULL
            AND expires_at &lt;= #{currentTime}
        ;
    </update>

    <!-- ì´ì „ ì°¨ë‹¨ ê¸°ë¡ ì‚­ì œ -->
    <delete id="deleteOldUnblockedRecords" parameterType="java.sql.Timestamp">
        /** ğŸ”´ IpBlockMapper.deleteOldUnblockedRecords - ì´ì „ ì°¨ë‹¨ ê¸°ë¡ ì‚­ì œ */
        DELETE FROM ip_block
        WHERE
            status IN ('UNBLOCKED', 'EXPIRED')
            AND updated_at &lt; #{beforeDate}
        ;
    </delete>

    <!-- ì°¨ë‹¨ í†µê³„ ì¡°íšŒ -->
    <select id="getBlockStatistics" parameterType="string" resultType="map">
        /** ğŸ”´ IpBlockMapper.getBlockStatistics - ì°¨ë‹¨ í†µê³„ ì¡°íšŒ */
        SELECT
            COUNT(*) AS totalBlocks,
            SUM(CASE WHEN status = 'ACTIVE' THEN 1 ELSE 0 END) AS activeBlocks,
            SUM(CASE WHEN status = 'EXPIRED' THEN 1 ELSE 0 END) AS expiredBlocks,
            SUM(CASE WHEN status = 'UNBLOCKED' THEN 1 ELSE 0 END) AS unblockedBlocks
        FROM
            ip_block
        WHERE
            project_code = #{appCode}
        ;
    </select>

    <!-- IP íŒ¨í„´ìœ¼ë¡œ ê²€ìƒ‰ -->
    <select id="findByIpPattern" parameterType="map" resultType="com.zinidata.domain.common.admin.vo.IpBlockVO">
        /** ğŸ”´ IpBlockMapper.findByIpPattern - IP íŒ¨í„´ ê²€ìƒ‰ */
        SELECT
            id,
            ip_address AS ipAddress,
            block_reason AS blockReason,
            is_permanent AS isPermanent,
            blocked_at AS blockedAt,
            unblocked_at AS unblockedAt,
            expires_at AS expiresAt,
            project_code AS appCode,
            blocked_by AS blockedBy,
            unblocked_by AS unblockedBy,
            created_at AS createdAt,
            updated_at AS updatedAt,
            status
        FROM
            ip_block
        WHERE
            ip_address LIKE #{ipPattern}
            AND project_code = #{appCode}
        ORDER BY
            created_at DESC
        ;
    </select>

</mapper> 
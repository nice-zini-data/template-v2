<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zinidata.domain.common.auth.mapper.AuthMapper">

    <select id="getMember" parameterType="map" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.getMember - ë¡œê·¸ì¸ ê²€ì¦ */
        SELECT
            a.*
        FROM
            tb_members a
        WHERE
            a.login_id = #{loginId}
            AND a.approval_yn = 'Y'
            AND a.prj_cd = #{appCode}
    </select>
    
    <update id="updateMemberSession" parameterType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.updateMemberSession - ë¡œê·¸ì¸ ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸ */
        UPDATE tb_members a
        SET
            a.login_session = #{loginSession},
            a.token = #{token},
            a.last_login_dt = #{loginTimestamp}
        WHERE
            AND a.mem_no = #{memNo}
        ;
    </update>

    <select id="existsByMobileNo" parameterType="string" resultType="int">
        /** ğŸŸ¢ AuthMapper.existsByMobileNo - íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ */
        SELECT COUNT(1)
        FROM tb_members a
        WHERE
            a.mobile_no = #{mobileNo}
            AND prj_cd = #{appCode}
    </select>
    
    <select id="existsByLoginId" parameterType="string" resultType="int">
        /** ğŸŸ¢ AuthMapper.existsByLoginId - ë¡œê·¸ì¸ ID ì¤‘ë³µ ì²´í¬ */
        SELECT COUNT(1)
        FROM tb_members a
        WHERE
            a.login_id = #{loginId}
            AND prj_cd = #{appCode}
    </select>

    <select id="getMemberSeq" resultType="java.lang.Long">
        --getMemberSeq íšŒì›ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        select nextval('tb_member_seq') as memNo
    </select>

    <insert id="insertMember" parameterType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.insertMember - íšŒì›ê°€ì… */
        INSERT INTO  tb_members(mem_no, login_id, pwd, email, mem_nm, mobile_no
                , prj_cd, department, auth_cd, use_yn, account_lock
                , created_dt, approval_yn, privacy_yn, marketing_yn, social_login_type
        ) VALUES (#{memNo}, #{loginId},#{password}, '', #{memNm}, #{mobileNo}
                , #{appCode}, #{department}, coalesce(#{authCd}, 'AUTH100'),'Y', 'N'
                , now(), 'Y', '', '', coalesce(#{socialLoginType}, 'nice'))
    </insert>

    <insert id="insertMemberInfo" parameterType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.insertMemberInfo - í”„ë¡œì íŠ¸ë³„ ê¶Œí•œì •ë³´ ë˜ëŠ” í”„ë¡œì íŠ¸ë³„ ì•„ì´ë”” ì •ë³´ */
        <!-- INSERT INTO tb_members_nvps
        VALUES (#{memNo}, #{team}, #{deptCd}, 'N', #{ip}) -->
    </insert>

    <update id="updateMember" parameterType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.updateMember - íšŒì› ì •ë³´ ìˆ˜ì • (ë¡œê·¸ì¸ ì‹œ API í˜¸ì¶œ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸) */
        UPDATE tb_members
        SET
            mem_nm = #{memNm},
            mobile_no = #{mobileNo},
            email = #{emailAddr},
            auth_cd = coalesce(#{authCd}, 'AUTH100'),
            updt_dt = NOW()
        WHERE
            mem_no = #{memNo}
            AND prj_cd = #{appCode}
    </update>

    <insert id="insertMemberNvps">
        /** ğŸŸ¢ AuthMapper.insertMemberNvps - tb_members_nvps í…Œì´ë¸”ì— íšŒì› ì •ë³´ insert */
        INSERT INTO tb_members_nvps (
            mem_no,
            user_code,
            agent_name,
            agent_code,
            p_agent_code,
            pg_agent_code,
            p_pg_agent_code,
            agent_business_no
        ) VALUES (
            #{memNo},
            #{nvpsInfo.userCode},
            #{nvpsInfo.agentName},
            #{nvpsInfo.agentCode},
            #{nvpsInfo.pAgentCode},
            #{nvpsInfo.pgAgentCode},
            #{nvpsInfo.pPgAgentCode},
            #{nvpsInfo.agentBusinessNo}
        )
    </insert>

    <update id="updateMemberNvps">
        /** ğŸŸ¢ AuthMapper.updateMemberNvps - tb_members_nvps í…Œì´ë¸”ì— íšŒì› ì •ë³´ update */
        UPDATE tb_members_nvps
        SET
            user_code = #{nvpsInfo.userCode},
            agent_name = #{nvpsInfo.agentName},
            agent_code = #{nvpsInfo.agentCode},
            p_agent_code = #{nvpsInfo.pAgentCode},
            pg_agent_code = #{nvpsInfo.pgAgentCode},
            p_pg_agent_code = #{nvpsInfo.pPgAgentCode},
            agent_business_no = #{nvpsInfo.agentBusinessNo}
        WHERE
            mem_no = #{memNo}
    </update>

    <update id="updatePassword" parameterType="map">
        /** ğŸŸ¢ AuthMapper.updatePassword - ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ */
        UPDATE tb_members
        SET
            pwd = #{password},
            updt_dt = NOW(),
        WHERE
            mem_no = #{memNo}
            AND prj_cd = #{appCode}
    </update>

    <delete id="deleteMember" parameterType="long">
        /** ğŸŸ¢ AuthMapper.deleteMember - íšŒì› íƒˆí‡´ */
        DELETE FROM tb_members
        WHERE
            mem_no = #{memNo}
            AND prj_cd = #{appCode}
    </delete>

    <insert id="backupMember" parameterType="long">
        /** ğŸŸ¢ AuthMapper.backupMember - íšŒì› ì •ë³´ ë°±ì—… */
        insert into tb_members_resign 
        select * , now() 
        from tb_members 
        where mem_no=#{memNo};
    </insert>


    <select id="findByLoginId" parameterType="com.zinidata.domain.common.auth.vo.MemberVO" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findByLoginId - ë¡œê·¸ì¸ IDë¡œ íšŒì› ì¡°íšŒ */
        SELECT *
        FROM tb_members
        WHERE login_id = #{loginId}
        AND prj_cd = #{appCode}
    </select>

    <select id="findByEmailAddr" parameterType="string" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findByEmailAddr - ì´ë©”ì¼ë¡œ íšŒì› ì¡°íšŒ */
        SELECT *
        FROM tb_members
        WHERE
            email = #{emailAddr}
    </select>

    <select id="findByMobileNo" parameterType="string" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findByMobileNo - íœ´ëŒ€í° ë²ˆí˜¸ë¡œ íšŒì› ì¡°íšŒ */
        SELECT *
        FROM tb_members
        WHERE
            mobile_no = #{mobileNo}
            AND prj_cd = #{appCode}
    </select>

    <select id="findByMemNmAndMobileNo" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findByMemNmAndMobileNo - ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ íšŒì› ì¡°íšŒ (ì•„ì´ë”” ì°¾ê¸°ìš©) */
        SELECT *
        FROM tb_members
        WHERE
            mem_nm = #{memNm}
            AND mobile_no = #{mobileNo}
            AND prj_cd = #{appCode}
    </select>

    <select id="findByLoginIdAndMobileNo" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findByLoginIdAndMobileNo - ë¡œê·¸ì¸ IDì™€ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ íšŒì› ì¡°íšŒ (ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°ìš©) */
        SELECT *
        FROM tb_members
        WHERE
            login_id = #{loginId}
            AND mobile_no = #{mobileNo}
            AND prj_cd = #{appCode}
    </select>

    <select id="findByMemNo" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findByMemNo - íšŒì› ë²ˆí˜¸ë¡œ íšŒì› ì¡°íšŒ */
        SELECT *
        FROM tb_members
        WHERE
            mem_no = #{memNo}
            AND prj_cd = #{appCode}
    </select>

    <select id="findMembers" parameterType="map" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.findMembers - íšŒì› ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ììš©) */
        SELECT *
        FROM tb_members
        WHERE
            prj_cd = #{appCode}
        ORDER BY coalesce(updt_dt, created_dt) DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="countMembers" resultType="int">
        /** ğŸŸ¢ AuthMapper.countMembers - íšŒì› ìˆ˜ ì¡°íšŒ (ê´€ë¦¬ììš©) */
        SELECT COUNT(*)
        FROM tb_members
        WHERE 
        prj_cd = #{appCode}
    </select>
    
    <select id="searchMembers" parameterType="map" resultType="com.zinidata.domain.common.auth.vo.MemberVO">
        /** ğŸŸ¢ AuthMapper.searchMembers - íšŒì› ê²€ìƒ‰ (ê´€ë¦¬ììš©) */
        SELECT *
        FROM tb_members
        WHERE
            prj_cd = #{appCode}
        AND (
            login_id LIKE CONCAT('%', #{keyword}, '%')
            OR mem_nm LIKE CONCAT('%', #{keyword}, '%')
            OR email LIKE CONCAT('%', #{keyword}, '%')
            OR mobile_no LIKE CONCAT('%', #{keyword}, '%')
            )
        ORDER BY coalesce(updt_dt, created_dt) DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countSearchMembers" parameterType="string" resultType="int">
        /** ğŸŸ¢ AuthMapper.countSearchMembers - íšŒì› ê²€ìƒ‰ ìˆ˜ ì¡°íšŒ (ê´€ë¦¬ììš©) */
        SELECT COUNT(*)
        FROM tb_members
        WHERE
            prj_cd = #{appCode}
            AND (
                login_id LIKE CONCAT('%', #{keyword}, '%')
                OR mem_nm LIKE CONCAT('%', #{keyword}, '%')
                OR email LIKE CONCAT('%', #{keyword}, '%')
                OR mobile_no LIKE CONCAT('%', #{keyword}, '%')
            )
    </select>

    <select id="countActiveMembers" resultType="int">
        /** ğŸŸ¢ AuthMapper.countActiveMembers - í™œì„± íšŒì› ìˆ˜ ì¡°íšŒ */
        SELECT COUNT(*)
        FROM tb_members
        WHERE
            prj_cd = #{appCode}
            AND approval_yn = 'Y'
    </select>

    <insert id="insertLogAuth">
        /** ğŸŸ¢ AuthMapper.insertLogAuth - ë¡œê·¸ì¸ ì¸ì¦ ì´ë ¥ ì €ì¥ */
        INSERT INTO tb_log_auth (
            log_auth_no,
            mem_no,
            session_id,
            login_dt,
            logout_dt,
            stay_second,
            force_logout_yn,
            ip_addr
        ) VALUES (
            nextval('tb_log_auth_seq'),
            #{memNo},
            #{sessionId},
            now(),
            NULL,
            NULL,
            'N',
            #{ipAddr}
        )
    </insert>

</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zinidata.domain.common.region.mapper.RegionMapper">

    <!-- ==================== Î∏îÎ°ù ÏøºÎ¶¨ ==================== -->
    
    <!-- Î∏îÎ°ù ÏΩîÎìúÎ°ú Î∏îÎ°ù Ï†ïÎ≥¥ Ï°∞Ìöå -->
    <select id="selectBlockByCode" parameterType="string" resultType="map">
        SELECT 
            blk_cd AS "blkCd",
            blk_nm AS "blkNm", 
            admi_cd AS "admiCd",
            minx AS "minX",
            miny AS "minY", 
            maxx AS "maxX",
            maxy AS "maxY",
            centerx AS "centerX",
            centery AS "centerY",
            feature AS "feature",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_block_v3_features
        WHERE blk_cd = #{blkCd}
    </select>
    
    <!-- Ï¢åÌëúÎ°ú Î∏îÎ°ù Ï°∞Ìöå -->
    <select id="selectBlockByPoint" resultType="map">
        SELECT 
            blk_cd AS "blkCd",
            blk_nm AS "blkNm",
            admi_cd AS "admiCd",
            centerx AS "centerX",
            centery AS "centerY",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_block_v3_features
        WHERE ST_Contains(geom, ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326))
        LIMIT 1
    </select>
    
    <!-- Ìè¥Î¶¨Í≥§ ÏòÅÏó≠ ÎÇ¥ Î∏îÎ°ù Ï°∞Ìöå -->
    <select id="selectBlocksByPolygon" parameterType="string" resultType="map">
        SELECT 
            blk_cd AS "blkCd",
            blk_nm AS "blkNm",
            admi_cd AS "admiCd",
            centerx AS "centerX", 
            centery AS "centerY"
        FROM cmapap.tbshp_block_v3_features
        WHERE ST_Intersects(geom, ST_SetSRID(ST_GeomFromText(#{polygon}), 4326))
        ORDER BY blk_cd
    </select>
    
    <!-- Î∞òÍ≤Ω ÎÇ¥ Î∏îÎ°ù Ï°∞Ìöå -->
    <select id="selectBlocksByRadius" resultType="map">
        SELECT 
            blk_cd AS "blkCd",
            blk_nm AS "blkNm",
            admi_cd AS "admiCd", 
            centerx AS "centerX",
            centery AS "centerY",
            ROUND(ST_Distance(
                geom, 
                ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326)::geography
            )::numeric, 1) AS "distance"
        FROM cmapap.tbshp_block_v3_features
        WHERE ST_DWithin(
            geom::geography,
            ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326)::geography,
            #{radius}
        )
        ORDER BY ST_Distance(geom, ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326))
    </select>

    <!-- ==================== ÌñâÏ†ïÎèô ÏøºÎ¶¨ ==================== -->
    
    <!-- ÌñâÏ†ïÎèô ÏΩîÎìúÎ°ú ÌñâÏ†ïÎèô Ï†ïÎ≥¥ Ï°∞Ìöå -->
    <select id="selectAdmiByCode" parameterType="string" resultType="map">
        SELECT 
            admi_cd AS "admiCd",
            admi_nm AS "admiNm",
            cty_cd AS "ctyCd",
            minx AS "minX",
            miny AS "minY",
            maxx AS "maxX", 
            maxy AS "maxY",
            centerx AS "centerX",
            centery AS "centerY",
            feature AS "feature",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_admi_features
        WHERE admi_cd = #{admiCd}
    </select>
    
    <!-- Ï¢åÌëúÎ°ú ÌñâÏ†ïÎèô Ï°∞Ìöå -->
    <select id="selectAdmiByPoint" resultType="map">
        /** üü¢ RegionMapper.selectAdmiByPoint - Ï¢åÌëúÎ°ú ÌñâÏ†ïÎèô Ï°∞Ìöå
         *  API: GET /api/common/region/admi/by-point
         *  Î™©Ï†Å: ÏßÄÎèÑ ÌÅ¥Î¶≠ Ï¢åÌëúÎ°ú Ìï¥Îãπ ÏúÑÏπòÏùò ÌñâÏ†ïÎèô Ï†ïÎ≥¥ Ï°∞Ìöå
         */
        SELECT 
            B.MEGA_CD AS "megaCd",
            B.MEGA_NM AS "megaNm",
            B.CTY_CD  AS "ctyCd",
            B.CTY_NM  AS "ctyNm",
            B.ADMI_CD AS "admiCd",
            B.ADMI_NM AS "admiNm",
            A.CENTERX AS "centerX",
            A.CENTERY AS "centerY",
            A.FEATURE AS "feature"
        FROM 
            TBSHP_ADMI_FEATURES A
        INNER JOIN 
            VWADM_ADMI B ON A.ADMI_CD = B.ADMI_CD
        WHERE 
            ST_Contains(A.GEOM, ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326))
        LIMIT 1
    </select>
    
    <!-- Ìè¥Î¶¨Í≥§ ÏòÅÏó≠ ÎÇ¥ ÌñâÏ†ïÎèô Ï°∞Ìöå -->
    <select id="selectAdmisByPolygon" parameterType="string" resultType="map">
        SELECT 
            admi_cd AS "admiCd",
            admi_nm AS "admiNm",
            cty_cd AS "ctyCd", 
            centerx AS "centerX",
            centery AS "centerY"
        FROM cmapap.tbshp_admi_features
        WHERE ST_Intersects(geom, ST_SetSRID(ST_GeomFromText(#{polygon}), 4326))
        ORDER BY admi_cd
    </select>
    
    <!-- Ïù∏Ï†ë ÌñâÏ†ïÎèô Ï°∞Ìöå -->
    <select id="selectAdjacentAdmis" parameterType="string" resultType="map">
        WITH base_admi AS (
            SELECT geom, admi_cd, admi_nm, cty_cd
            FROM cmapap.tbshp_admi_features 
            WHERE admi_cd = #{admiCd}
        )
        SELECT 
            a.admi_cd AS "admiCd",
            a.admi_nm AS "admiNm", 
            a.cty_cd AS "ctyCd",
            a.centerx AS "centerX",
            a.centery AS "centerY",
            CASE WHEN a.admi_cd = #{admiCd} THEN true ELSE false END AS "isBase"
        FROM cmapap.tbshp_admi_features a, base_admi b
        WHERE a.admi_cd = #{admiCd}
           OR ST_Touches(a.geom, b.geom)
        ORDER BY "isBase" DESC, a.admi_cd
    </select>

    <!-- ==================== ÏãúÍµ∞Íµ¨ ÏøºÎ¶¨ ==================== -->
    
    <!-- ÏãúÍµ∞Íµ¨ ÏΩîÎìúÎ°ú ÏãúÍµ∞Íµ¨ Ï†ïÎ≥¥ Ï°∞Ìöå -->
    <select id="selectCtyByCode" parameterType="string" resultType="map">
        SELECT 
            cty_cd AS "ctyCd",
            cty_nm AS "ctyNm",
            mega_cd AS "megaCd",
            minx AS "minX",
            miny AS "minY",
            maxx AS "maxX",
            maxy AS "maxY", 
            centerx AS "centerX",
            centery AS "centerY",
            feature AS "feature",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_cty_features
        WHERE cty_cd = #{ctyCd}
    </select>
    
    <!-- Ï¢åÌëúÎ°ú ÏãúÍµ∞Íµ¨ Ï°∞Ìöå -->
    <select id="selectCtyByPoint" resultType="map">
        SELECT 
            cty_cd AS "ctyCd",
            cty_nm AS "ctyNm",
            mega_cd AS "megaCd",
            centerx AS "centerX", 
            centery AS "centerY",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_cty_features
        WHERE ST_Contains(geom, ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326))
        LIMIT 1
    </select>
    
    <!-- Ìè¥Î¶¨Í≥§ ÏòÅÏó≠ ÎÇ¥ ÏãúÍµ∞Íµ¨ Ï°∞Ìöå -->
    <select id="selectCtysByPolygon" parameterType="string" resultType="map">
        SELECT 
            cty_cd AS "ctyCd",
            cty_nm AS "ctyNm", 
            mega_cd AS "megaCd",
            centerx AS "centerX",
            centery AS "centerY"
        FROM cmapap.tbshp_cty_features
        WHERE ST_Intersects(geom, ST_SetSRID(ST_GeomFromText(#{polygon}), 4326))
        ORDER BY cty_cd
    </select>

    <!-- ==================== Í¥ëÏó≠ÏãúÎèÑ ÏøºÎ¶¨ ==================== -->
    
    <!-- Í¥ëÏó≠ÏãúÎèÑ ÏΩîÎìúÎ°ú Í¥ëÏó≠ÏãúÎèÑ Ï†ïÎ≥¥ Ï°∞Ìöå -->
    <select id="selectMegaByCode" parameterType="string" resultType="map">
        SELECT 
            mega_cd AS "megaCd",
            mega_nm AS "megaNm",
            minx AS "minX",
            miny AS "minY",
            maxx AS "maxX",
            maxy AS "maxY",
            centerx AS "centerX",
            centery AS "centerY", 
            feature AS "feature",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_mega_features
        WHERE mega_cd = #{megaCd}
    </select>
    
    <!-- Ï¢åÌëúÎ°ú Í¥ëÏó≠ÏãúÎèÑ Ï°∞Ìöå -->
    <select id="selectMegaByPoint" resultType="map">
        SELECT 
            mega_cd AS "megaCd",
            mega_nm AS "megaNm",
            centerx AS "centerX",
            centery AS "centerY",
            ST_AsGeoJSON(geom) AS "geoJson"
        FROM cmapap.tbshp_mega_features
        WHERE ST_Contains(geom, ST_SetSRID(ST_Point(#{lng}, #{lat}), 4326))
        LIMIT 1
    </select>
    
    <!-- Ìè¥Î¶¨Í≥§ ÏòÅÏó≠ ÎÇ¥ Í¥ëÏó≠ÏãúÎèÑ Ï°∞Ìöå -->
    <select id="selectMegasByPolygon" parameterType="string" resultType="map">
        SELECT 
            mega_cd AS "megaCd",
            mega_nm AS "megaNm",
            centerx AS "centerX",
            centery AS "centerY"
        FROM cmapap.tbshp_mega_features
        WHERE ST_Intersects(geom, ST_SetSRID(ST_GeomFromText(#{polygon}), 4326))
        ORDER BY mega_cd
    </select>

    <!-- ÌôïÏû• Î∂ÑÏÑù ÌñâÏ†ïÎèô geometry Ï†ïÎ≥¥ Ï°∞Ìöå -->
    <select id="getExpandedAdmiRegions" resultType="map">
        /** üü¢ RegionMapper.getExpandedAdmiRegions - ÌôïÏû• Î∂ÑÏÑù ÌñâÏ†ïÎèô geometry Ï†ïÎ≥¥ Ï°∞Ìöå
            *  API: GET /api/explorer/summary/check-analyzability (Í∞ÑÏ†ë Ìò∏Ï∂ú)
            *  Î™©Ï†Å: ÌôïÏû• Î∂ÑÏÑùÏóê Ìè¨Ìï®ÎêòÎäî ÌñâÏ†ïÎèôÎì§Ïùò geometry Ï†ïÎ≥¥ Ï°∞Ìöå (ÏßÄÎèÑ ÌëúÏãúÏö©)
            */
        SELECT 
            B.ADMI_CD AS "admiCd",
            B.ADMI_NM AS "admiNm",
            B.CENTERX AS "centerX",
            B.CENTERY AS "centerY",
            B.FEATURE AS "feature"
        FROM 
            TB_ADMI_TOUCH A
        INNER JOIN 
            TBSHP_ADMI_FEATURES B ON A.TCH_ADMI_CD = B.ADMI_CD
        WHERE 
            A.STD_ADMI_CD = #{admiCd}
    </select>

    <!-- ÏãúÎèÑ Î™©Î°ù Ï°∞Ìöå -->
    <select id="getMegaList" resultType="map">
        /** üü¢ RegionMapper.getMegaList - ÏãúÎèÑ Î™©Î°ù Ï°∞Ìöå
            *  API: POST /api/common/region/mega/list
            *  Î™©Ï†Å: Ï†ÑÍµ≠ ÏãúÎèÑ ÏΩîÎìúÏôÄ Ïù¥Î¶Ñ Î™©Î°ùÏùÑ Ï°∞ÌöåÌï©ÎãàÎã§.
            */
        SELECT DISTINCT mega_cd, mega_nm
          FROM vwadm_admi
         ORDER BY 1
    </select>

</mapper> 